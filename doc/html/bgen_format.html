<!DOCTYPE HTML PUBLIC "-//SoftQuad Software//DTD HoTMetaL PRO 6.0::19990601::extensions to HTML 4.0//EN" "hmpro6.dtd">
<HTML> 
  <HEAD> 
	 <TITLE>Gavin Band's webspace at the Wellcome Trust Centre for Human Genetics</TITLE><META
	 NAME="keywords" CONTENT="human genetics research"><LINK HREF="/styles/main.css"
	 REL="stylesheet"><SCRIPT SRC="/scripts/random_images.js"></SCRIPT><SCRIPT SRC="/scripts/date.js"></SCRIPT> 
	<LINK HREF="style.css" REL="stylesheet">  </HEAD> 
  <BODY ALINK="orange"> 
	 <CENTER> 
		<TABLE CELLSPACING="0" CELLPADDING="0" BORDER="0"> 
		  <TR> 
			 <TD WIDTH="150" VALIGN="TOP" CLASS="border"><SCRIPT SRC="/scripts/load_random_image.js"></SCRIPT> 
				<P><A HREF="template.shtml">Group research interests</A></P> 
				<P><A HREF="template.shtml">Link to another group item </A></P> 
				<P><A HREF="template.shtml">A Sub-group</A></P> 
				<P><A HREF="template.shtml">A research topic</A></P> 
				<P><A HREF="template.shtml">Some meeting dates</A></P> 
				<P><A HREF="template.shtml">Group people</A></P>&nbsp;</TD> 
			 <TD>
			 <!--#include virtual="/header.shtml" -->
			<DIV>
				<div id="gavsheader">Gavin Band's webspace </div>
				<h2>A Binary GEN file format - BGEN</h2>
            <p>
            <b>This page documents version 1.0 of the BGEN format.</b>
            </p>
			<h3>Background</h3>

				<p>
            		A <a href="http://www.stats.ox.ac.uk/%7Emarchini/software/gwas/file_format.html">GEN file</a> typically contains
                 millions of floating-point numbers -- often in a fixed format -- stored in the file in a textual
                 representation. For example, for a cohort of 1500 individuals, typed at 30000 SNPs, to store the AA, AB and BB
                 genotype probabilities takes 1500 x 30000 x 3 = 135 million floating-point numbers. Consequently, programs
                 which manipulate this data must spend a long time parsing the numbers to produce in-memory float or double
                 quantities. For simple programs this time can dominate the program execution time.  </p> <p>
                 This page describes a binary GEN file format (the "BGEN" format) which overcomes this problem. Tests show
                 that using this binary format can acheive a file input speed increase of 5-10x.
				</p>
				<p>A C++ implementation of this file format is available as the "genfile" sublibrary of the gen-tools package, available <a href="http://bitbucket.org/gavinband/gen-tools-dev/">here</a>.
				<h2>Overview</h2>
				
				<p>
				A <em>BGEN</em> file consists of a header block, followed by a series of blocks called snp blocks.  The first four
				bytes of the file indicate the start position of the first snp block (relative to the fifth byte of the file).
				<p>
					<b>Note: All numbers in the file are stored as integers in little endian (least significant byte first)
                    order.</b>  This choice coincides with the memory layout
                    used on most common Intel architectures. see the <a
                    href="http://en.wikipedia.org/wiki/Endianness">wikipedia page</a> for more details.
				</p>
				<h2>Detailed specification</h2>
				<h3>The first four bytes</h3>
				<p>
				The first four bytes of the file encode an unsigned integer indicating the offset, relative to the 5th byte of the file, of the
                start of the first snp block (or the end of the file if there are 0 snp blocks). For example, if this offset is 0, the snp
                blocks start at byte 5.
				</p>
				<center>
				<table class="filespec">
					<tr><th>No. of bytes</th><th>Description</th></tr>
					<tr><td>4</td><td>An unsigned integer <em>offset</em> indicating the offset, relative to the fifth
                       byte of the file, of the first byte of the first snp block (or the end of the file if there are no
                       snp blocks).</td></tr>
					<tr><th>4</th><th>TOTAL</th></tr>
				</table>
				</center>

				<h3>The header block</h3>
            <p>
				The header block contains global information about the file.
            </p>
            <center>
            <table class="filespec">
					<tr><th>No. of bytes</th><th>Description</th></tr>
					<tr><td>4</td><td>An unsigned integer <em>H</em> indicating the length, in bytes, of the header block.
						This must not be larger than <em>offset</em>.</td></tr>
               <tr><td>4</td><td>An unsigned integer indicating the number of snp blocks stored in the file.</td></tr>
               <tr><td>4</td><td>An unsigned integer indicating the number of samples represented in the snp blocks in the file.</td></tr>
               <tr><td>4</td><td>Reserved.  (Writers should write 0 here, readers should ignore these bytes.)</td></tr>
               <tr><td><em>H</em>-20</td><td>Free data area.  This could be used to store, for example, identifying information about the file</td></tr>
               <tr><td>4</td><td>A set of <em>flags</em>, with bits numbered as for an unsigned integer.  See below for flag definitions.</td></tr>
					<tr><th>20 + <em>L</em></th><th>TOTAL</th></tr>
				</table>
            </center>

            <h3>Header block -- flag definitions</h3>
            <p>
            The following flags can be contained in the <em>flags</em> field in the header block. <b>Note</b>: all bits not listed here must be set to 0.
            </p>
            <center>
            <table class="filespec">
					<tr><th>Bit</th><th>Name</th><th>Value</th><th>Description</th></tr>
					<tr><td>0</td><td><em>CompressedSNPBlocks</em></td><td>0</td><td>Indicates SNP block probability data is not compressed.</td></tr>
					<tr><td></td><td></td><td>1</td><td>Indicates SNP block probability data is compressed using zlib's compress() function.</td></tr>
				</table>
            </center>

            
				<h3>The snp blocks</h3>
				<p>
					Following the header comes a sequence of 0 or more snp blocks.
	 				Each snp block consists of the following data in order.
				</p>
				<center>
				<table class="filespec">
					<thead>
					<tr><th>No. of bytes</th><th>Description</th></tr>
					</thead>
					<tbody>
					<tr><td>4</td><td>The number of individuals the row represents, hereafter denoted <em>N</em>.
						This is an integer encoded in two bytes.</td></tr>
					<tr><td>1</td><td>An unsigned integer <em>S</em>, indicating the length of the storage used for the
                    SNPID and RSID fields in the row.</td></tr>
					<tr><td>1</td><td>The length, <em>SNPID_size</em> of (the data part of) the SNPID string.
						This must be between 0 and <em>S</em>.</td></tr>
					<tr><td><em>S</em></td><td>The SNPID of the row.  
						Only the first <em>SNPID_size</em> bytes will be used.</td></tr>
					<tr><td>1</td><td>The length, <em>RSID_size</em> of (the data part of) the RSID string.
							This must be between 0 and <em>S</em>.</td></tr>
					<td><em>S</em></td><td>The RSID of the row.  
						Only the first <em>RSID_size</em> bytes will be used.</td></tr>
					<tr><td>1</td><td>
						The chromosome on which the SNP is found, encoded as an unsigned 8-byte integer.
						The encoding is:
						<table class="field_encoding_scheme" >
							<tr><td>1-22:</td><td>SNP lies in the chromosome with the given number.</td></tr>
							<tr><td>23</td><td>SNP lies in the non pseudo-autosomal part of the X chromosome.</td></tr>
							<tr><td>24:</td><td>SNP lies in the non pseudo-autosomal part of the Y chromosome.</td></tr>
							<tr><td>253:</td><td>SNP lies in the pseudo-autosomal region of the X/Y chromosomes.</td></tr>
							<tr><td>254:</td><td>SNP lies in the mitochondrial DNA</td></tr>
							<tr><td>255:</td><td>Indicates the chromosome is unknown.  We advise that this only be used for test data.</td></tr>
						</table>
					</td>
					<tr><td>4</td><td>The SNP position, encoded as an unsigned 32-bit integer.</td></tr>
					<tr><td>1</td><td>the A SNP allele, this should be 'A', 'C', 'T', or 'G'.</td></tr>
					<tr><td>1</td><td>The B SNP allele, this should be 'A', 'C', 'T', or 'G'.</td></tr>
					<tr><td><em>P</em></td><td>Genotype probability data for the SNP for each of the N individuals in
                    the cohort.  If the <em>CompressedSNPBlocks</em> flag is not set, this field consists of <em>P</em>=6*<em>N</em> bytes representing the probabilities.
                 	If <em>CompressedSNPBlocks</em> is set, this field contains a 32-bit unsigned integer specifying the length of the compressed data,
					followed by the compressed data itself.  See below for more details.</td></tr>
					</tbody>
					<tfoot>
					<tr><th>13 + 2*<em>S</em> + <em>P</em></th><th>TOTAL</th></tr>
					</tfoot>
				</table>
				</center>
				</p>
            <h3>SNP block probability data</h3>
            <p>
					The probability data is listed as a sequence of 2-byte signed integers.  These should be interpreted in triples,
					the first member being the probability of AA, the second the probability of AB, the third the probability of BB.
					Altogether these occupy 6*<em>N</em> bytes where <em>N</em> is the number of samples.  These 6 * <em>N</em> bytes are written directly.
            <b>Alternatively</b>, if the <em>CompressedSNPBlocks</em> flag is set in the header, these 6 * <em>N</em> bytes are first compressed using <a href="http://www.zlib.net/">zlib</a>.
            The SNP block then contains a 4-byte integer representing the length of the compressed data followed by the compressed data itself.
            </p>
            <p>
					To convert the stored 2-byte integers into probabilities, the following calculation should be performed:
				</p>
				<ol>
					<li>Convert the number into a floating-point format (e.g. float or double).</li>
					<li>Divide by 10,000.</li>
				</ol>
				<p>
					Note that the range of a two-byte unsigned integer is 0 - 65535 inclusive. Thus the resulting probabilities
                    can take on values between 0 and 6.5535 inclusive and are accurate to four decimal places.
				</p>
				<p>
					<b>Note</b>: to convert a floating point number to the format, do the following:
				</p>
				<ol>
					<li>Check the number lies in the half-open interval [ 0, 6.55355 ).</li>
					<li>Multiply by 10000 and round to the nearest integer.</li>
				</ol>
				<p>
					All numbers are stored in little-endian (least significant byte first) order.
				</p>
			</DIV>	
			</TD> 
			 <TD WIDTH="40"><IMG SRC="/images/whitespace.gif" WIDTH="1"
				HEIGHT="480" BORDER="0" HSPACE="0" VSPACE="0" ALIGN="LEFT"> &nbsp;</TD> 
		  </TR> 
		  <TR> 
			 <TD CLASS="borderline"><IMG SRC="/images/bluespace.gif" ALT="spacer"
				WIDTH="1" HEIGHT="100" BORDER="0" HSPACE="0" VSPACE="0" ALIGN="RIGHT"></TD> 
			 <TD CLASS="footer" VALIGN="TOP"> 
			 <!--#include virtual="/footer.shtml"--></TD> 
			 <TD WIDTH="40"></TD> 
		  </TR> 
		</TABLE></CENTER> </BODY>
</HTML>
